"use strict";var e={id:"openai-auto-translate",handler:async({item_ids:e,collection:t,language_table:n},{env:a,services:o,getSchema:l})=>{const s=require("openai");if(null==a.OPENAI_API_KEY)return"API Key not defined";if(null==a.OPENAI_RATE_LIMIT)return"API Key not defined";const i=new s({apiKey:a.OPENAI_API_KEY}),c=[],r=[],{ItemsService:u}=o,d=await l(),h=new u(`${t}_translations`,{schema:d}),g=new u(n,{schema:d});async function f(e,t,n){await _(e*a.OPENAI_RATE_LIMIT).then((()=>{i.chat.completions.create({messages:[{role:"system",content:"You will be provided a JSON document and your task is to translate it into "+t.name+". You must answer with a valid JSON. Dont change the structure of the JSON. Only change the values. And please double check that the JSON is valid."},{role:"user",content:JSON.stringify(n)}],model:"gpt-3.5-turbo"}).then((e=>{if(null==e)return;let n=JSON.parse(e.choices[0].message.content.replace('\\"','"'));n.languages_code=t.code,h.createOne(n).then((e=>{c.push(e)})).catch((e=>{console.log(e),r.push(e)}))})).catch((e=>{console.log(e),r.push(e)}))}))}async function _(e){return new Promise((t=>setTimeout(t,e)))}h.readByQuery({fields:["*"],filter:{[`${t}_id`]:{_in:e}}}).then((e=>{if(null==e[0])return"No initial sample found.";g.readByQuery({fields:["code","name"],filter:{code:{_neq:e[0].languages_code}}}).then((async t=>{let n=e[0];delete n.id;const o=n;if(0===t.length)return"No languages found in table.";for(let n=0;n<t.length;n++)e.filter((e=>e.languages_code===t[n].code)).length>0||await f(n,t[n],o);await _(t.length*a.OPENAI_RATE_LIMIT).then((()=>(console.log(c),console.log(r),r.length>0?r:c)))}))}))}};module.exports=e;
